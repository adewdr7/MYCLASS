<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Academy - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@700;800&family=Orbitron:wght@900&display=swap');
        :root { --bg-deep: #02040a; }
        body { background-color: var(--bg-deep); color: white; font-family: 'Baloo 2', cursive; margin: 0; overflow-x: hidden; min-height: 100vh; }
        #star-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at center, #0d1117 0%, #02040a 100%); }
        .main-container { width: 100%; padding: 20px 15px 100px 15px; display: flex; flex-direction: column; gap: 25px; }
        
        .name-card { 
            width: 75%; min-height: 90px; 
            background: rgba(255, 255, 255, 0.03); 
            backdrop-filter: blur(10px); 
            border: 3px solid var(--neon-clr); 
            border-radius: 25px; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; position: relative; transition: all 0.3s ease; 
            box-shadow: 0 0 15px var(--neon-shadow); 
        }
        
        .name-card.claimed {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(1);
            border-style: dashed;
        }

        .name-card:nth-child(odd) { align-self: flex-start; margin-right: auto; }
        .name-card:nth-child(even) { align-self: flex-end; margin-left: auto; }
        
        .name-card:not(.claimed):hover { 
            transform: scale(1.05); 
            background: rgba(255, 255, 255, 0.1); 
            box-shadow: 0 0 30px var(--neon-clr); 
            z-index: 10; 
        }

        .student-name { 
            font-size: 2rem; font-weight: 800; color: white; letter-spacing: 2px; 
            paint-order: stroke fill; -webkit-text-stroke: 5px var(--neon-clr); 
            text-shadow: 0 0 10px var(--neon-clr); line-height: 1.2; text-align: center; padding: 5px 15px; 
        }

        .clr-cyan { --neon-clr: #00f2ff; --neon-shadow: rgba(0, 242, 255, 0.3); }
        .clr-pink { --neon-clr: #ff00ff; --neon-shadow: rgba(255, 0, 255, 0.3); }
        .clr-lime { --neon-clr: #00ff88; --neon-shadow: rgba(0, 255, 136, 0.3); }
        .clr-gold { --neon-clr: #ffcc00; --neon-shadow: rgba(255, 204, 0, 0.3); }
        .clr-purple { --neon-clr: #bc13fe; --neon-shadow: rgba(188, 19, 254, 0.3); }
        .clr-orange { --neon-clr: #ff6b00; --neon-shadow: rgba(255, 107, 0, 0.3); }

        .admin-tag { position: absolute; top: -10px; left: 20px; background: var(--neon-clr); color: black; padding: 0 10px; border-radius: 8px; font-size: 10px; font-weight: 900; font-family: 'Orbitron', sans-serif; }
        .tester-tag { position: absolute; bottom: -10px; right: 20px; background: white; color: black; padding: 0 8px; border-radius: 4px; font-size: 8px; font-weight: 900; }
        
        @media (min-width: 768px) { .name-card { width: 500px; min-height: 110px; } .student-name { font-size: 3rem; } }
        
        .error-msg { color: #ff4444; font-size: 12px; margin-top: 10px; font-family: sans-serif; }
    </style>
</head>
<body>
    <canvas id="star-canvas"></canvas>
    <header class="pt-12 pb-8 text-center px-4">
        <h1 class="text-3xl font-black tracking-widest text-white mb-2" style="font-family: 'Orbitron';">STELLAR LOGIN</h1>
        <p class="text-[10px] text-cyan-400 uppercase tracking-[0.3em]">Pilih Namamu</p>
    </header>

    <div id="zigzag-list" class="main-container">
        <div class="text-center text-slate-500 italic">Menghubungkan ke satelit...</div>
    </div>

    <div id="login-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md px-6">
        <div id="modal-box" class="border-4 p-8 rounded-[40px] bg-gray-950 text-center w-full max-w-sm">
            <h2 id="modal-name" class="text-4xl font-black mb-8 text-white">NAME</h2>
            <button id="confirm-btn" class="w-full py-4 bg-white text-black rounded-2xl font-black text-lg hover:bg-cyan-400 transition-all uppercase">
                AKTIVASI POS
            </button>
            <div id="error-display" class="error-msg hidden"></div>
            <button id="close-btn" class="mt-6 text-gray-500 uppercase text-[10px]">Kembali</button>
        </div>
    </div>

    <script type="module">
        import { loginWithName, subscribeNames } from './app.js';

        // Ditambahkan AKUN TESTER (isT: true) yang tidak akan terkunci
        const usersList = [
    // TESTER & ADMIN UTAMA
    { n: "DEV_ADMIN", r: "admin", c: "clr-gold", isT: true },
    { n: "DEV_MURID", r: "murid", c: "clr-cyan", isT: true },

    // GURU / COMMANDERS
    { n: "IBU YAYAH", r: "admin", c: "clr-gold", mapel: "WALI KELAS / UMUM" },
    { n: "BPK JAJANG", r: "admin", c: "clr-gold", mapel: "PJOK" },
    { n: "IBU ILAH", r: "admin", c: "clr-gold", mapel: "B. INGGRIS" },
    { n: "IBU LINA", r: "admin", c: "clr-gold", mapel: "PAI" },
            { n: "AINUN", r: "murid", c: "clr-cyan" },
            { n: "AKBAR", r: "murid", c: "clr-pink" },
            { n: "ALIFA", r: "murid", c: "clr-lime" },
            { n: "AMORA", r: "murid", c: "clr-purple" },
            { n: "AZKA", r: "murid", c: "clr-orange" },
            { n: "DIMAS", r: "murid", c: "clr-cyan" },
            { n: "ALFI", r: "murid", c: "clr-pink" },
            { n: "FHAREL", r: "murid", c: "clr-lime" },
            { n: "HAFIZA", r: "murid", c: "clr-purple" },
            { n: "JIHAN", r: "murid", c: "clr-orange" },
            { n: "KHALIFA", r: "murid", c: "clr-gold" },
            { n: "AULIA", r: "murid", c: "clr-cyan" },
            { n: "PUJA", r: "murid", c: "clr-pink" },
            { n: "REZA.P", r: "murid", c: "clr-lime" },
            { n: "REZA.R", r: "murid", c: "clr-purple" },
            { n: "DEWI", r: "murid", c: "clr-orange" },
            { n: "NOVA", r: "murid", c: "clr-cyan" },
            { n: "ALBY", r: "murid", c: "clr-pink" },
            { n: "ARESHA", r: "murid", c: "clr-lime" }
        ];

        let selected = null;
        let isProcessing = false;
        let claimedNames = {};

        subscribeNames((data) => {
            claimedNames = data;
            render();
        });

        function render() {
    const list = document.getElementById('zigzag-list');
    list.innerHTML = usersList.map((u, i) => {
        const isClaimed = !u.isT && claimedNames[u.n] && claimedNames[u.n].claimedBy;
        
        // Cek apakah ini akun guru untuk menampilkan info mapel
        const subText = u.mapel ? `<div class="text-[10px] text-white/60 mt-1 uppercase tracking-tighter">${u.mapel}</div>` : '';

        return `
            <div class="name-card ${u.c} ${isClaimed ? 'claimed' : ''}" data-idx="${i}">
                ${u.r === 'admin' ? '<div class="admin-tag">COMMANDER</div>' : ''}
                ${u.isT ? '<div class="tester-tag">TESTER MODE</div>' : ''}
                <div class="flex flex-col items-center">
                    <div class="student-name">${u.n}</div>
                    ${subText} 
                </div>
                ${isClaimed ? '<div class="absolute bottom-2 right-4 text-[8px] text-white/40 italic">OCCUPIED</div>' : ''}
            </div>
        `;
    }).join('');
            document.querySelectorAll('.name-card').forEach(card => {
                card.onclick = () => {
                    const idx = card.getAttribute('data-idx');
                    const user = usersList[idx];
                    const isClaimed = !user.isT && claimedNames[user.n] && claimedNames[user.n].claimedBy;
                    if(!isClaimed) openModal(idx);
                };
            });
        }

        window.openModal = function(idx) {
            if(isProcessing) return;
            selected = usersList[idx];
            const modal = document.getElementById('login-modal');
            const mName = document.getElementById('modal-name');
            const mBox = document.getElementById('modal-box');
            
            document.getElementById('error-display').classList.add('hidden');
            mName.innerText = selected.n;
            mName.style.webkitTextStroke = `6px var(--neon-clr)`;
            mBox.style.borderColor = `var(--neon-clr)`;
            mBox.style.boxShadow = `0 0 50px var(--neon-clr)`;
            modal.classList.remove('hidden');
        };

        window.closeModal = function() {
            if(isProcessing) return;
            document.getElementById('login-modal').classList.add('hidden');
        };

        async function confirmEntry() {
            if (!selected || isProcessing) return;

            const btn = document.getElementById('confirm-btn');
            const errDiv = document.getElementById('error-display');
            
            isProcessing = true;
            btn.innerText = "AUTHENTICATING...";
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            errDiv.classList.add('hidden');

            try {
                // Kita kirim parameter isTester (selected.isT) ke app.js
                const result = await loginWithName(selected.n, selected.r, selected.isT || false);
                
          // Di dalam file index.html
if (result.success) {
    // Simpan data user ke storage agar bisa dibaca di halaman lain
    localStorage.setItem('userName', selected.n);
    localStorage.setItem('userRole', selected.r);
    localStorage.setItem('isTester', selected.isT || false);

    btn.innerText = "ACCESS GRANTED";
    btn.style.backgroundColor = "#00ff88";
    setTimeout(() => {
        window.location.href = 'dashboard.html';
    }, 800);
}
 else {
                    throw new Error(result.error);
                }
            } catch (error) {
                isProcessing = false;
                btn.innerText = "AKTIVASI POS";
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                errDiv.innerText = error.message === 'taken' ? "Nama sudah digunakan orang lain!" : error.message;
                errDiv.classList.remove('hidden');
            }
        }

        document.getElementById('confirm-btn').onclick = confirmEntry;
        document.getElementById('close-btn').onclick = closeModal;

        // Bintang Latar
        const canvas = document.getElementById('star-canvas');
        const ctx = canvas.getContext('2d');
        let stars = [];
        function initStars() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            stars = Array.from({length: 80}, () => ({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, s: Math.random() * 1.5, v: Math.random() * 0.3 + 0.1 }));
        }
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = "white";
            stars.forEach(s => { ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI * 2); ctx.fill(); s.y += s.v; if (s.y > canvas.height) s.y = 0; });
            requestAnimationFrame(draw);
        }
        initStars(); draw(); render();
        window.addEventListener('resize', initStars);
    </script>
</body>
</html>


