<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Academy - Buat Materi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <script src="cloudinary-config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #050505; color: white; min-height: 100vh; }
        .glass { backdrop-filter: blur(16px); background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); }
        .neon-text { background: linear-gradient(to right, #22d3ee, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        input, textarea, select { background: rgba(255, 255, 255, 0.05) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; color: white !important; outline: none !important; }
        input:focus, textarea:focus, select:focus { border-color: #22d3ee !important; }
        .tester-badge { background: linear-gradient(45deg, #f59e0b, #ef4444); box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
    </style>
</head>
<body class="p-5 md:p-10">
    
    <div class="max-w-4xl mx-auto flex items-center justify-between mb-10">
        <a href="dashboard.html" class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors">
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
            <span>Dashboard</span>
        </a>
        <div class="text-right">
            <h1 class="text-2xl font-black uppercase neon-text">Mission Control</h1>
            <p class="text-xs text-slate-500 uppercase font-bold tracking-widest">Database Sync Active</p>
        </div>
    </div>

    <!-- Tester Panel -->
    <div id="tester-panel" class="max-w-4xl mx-auto mb-6 hidden">
        <div class="glass border-orange-500/30 rounded-2xl p-4 flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="tester-badge text-[10px] font-black px-2 py-1 rounded-md text-white uppercase">Tester Mode</div>
                <p class="text-sm text-slate-300 italic">Ganti identitas guru:</p>
            </div>
            <select id="tester-identity-select" class="p-2 rounded-lg text-sm glass cursor-pointer border-orange-500/50">
                <option value="IBU YAYAH">Ibu Yayah (Wali Kelas)</option>
                <option value="BPK JAJANG">Bapak Jajang (PJOK)</option>
                <option value="IBU ILAH">Ibu Ilah (B. Inggris)</option>
                <option value="IBU LINA">Ibu Lina (PAI)</option>
                <option value="DEV_ADMIN">Admin Pengembang</option>
            </select>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <div class="glass rounded-3xl p-8 border border-white/10 relative overflow-hidden">
            <form id="materi-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-300">Judul Materi</label>
                        <input type="text" id="judul" class="w-full p-4 rounded-2xl" required>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-300">Pelajaran</label>
                        <select id="mapel-select" class="w-full p-4 rounded-2xl" required></select>
                    </div>
                </div>

                <!-- Media Upload Area -->
                <div class="space-y-2">
                    <label class="text-sm font-semibold text-slate-300 ml-1">Media (Cloudinary)</label>
                    <div id="drop-area" onclick="launchCloudinary()" class="border-2 border-dashed border-white/10 rounded-2xl p-8 text-center hover:border-cyan-500/50 cursor-pointer group">
                        <div id="preview-container" class="hidden mb-4">
                            <div class="inline-flex items-center gap-2 bg-cyan-500/20 text-cyan-400 px-5 py-2 rounded-full border border-cyan-500/30 text-xs font-bold">
                                <i data-lucide="file-check" class="w-4 h-4"></i>
                                <span id="file-name-display">Media Terpasang</span>
                            </div>
                        </div>
                        <div id="placeholder-info">
                            <i data-lucide="cloud-upload" class="w-10 h-10 mx-auto text-slate-600 group-hover:text-cyan-400 mb-2 transition-colors"></i>
                            <p class="text-sm text-slate-400">Lampirkan Video/Gambar/Audio</p>
                        </div>
                    </div>
                    <input type="hidden" id="media-url">
                    <input type="hidden" id="media-type">
                </div>

                <div class="space-y-2">
                    <label class="text-sm font-semibold text-slate-300">Ringkasan Materi</label>
                    <input type="text" id="deskripsi" class="w-full p-4 rounded-2xl">
                </div>

                <div class="space-y-2">
                    <label class="text-sm font-semibold text-slate-300">Isi Konten</label>
                    <textarea id="konten" rows="6" class="w-full p-4 rounded-2xl resize-none" required></textarea>
                </div>

                <div class="flex items-center justify-between pt-6 border-t border-white/5">
                    <div class="text-xs text-slate-500">Author: <span id="author-name" class="text-cyan-400 font-bold uppercase">...</span></div>
                    <button type="submit" id="btn-submit" class="bg-white text-black px-10 py-4 rounded-2xl font-black hover:bg-cyan-400 transition-all">LUNCURKAN MATERI</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = JSON.parse(localStorage.getItem('firebaseConfig') || '{}');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = localStorage.getItem('appId') || 'stellar-academy';

        const guruMapel = {
            "IBU YAYAH": ["Pendidikan Pancasila", "Bahasa Indonesia", "Seni Budaya", "Bahasa Sunda"],
            "BPK JAJANG": ["PJOK"],
            "IBU ILAH": ["Bahasa Inggris"],
            "IBU LINA": ["Agama Islam"],
            "DEV_ADMIN": ["Pendidikan Pancasila", "Bahasa Indonesia", "PJOK", "Bahasa Inggris", "Agama Islam", "Seni Budaya", "Bahasa Sunda"]
        };

        let activeUser = localStorage.getItem('userName') || 'GUEST';
        const isTester = localStorage.getItem('isTester') === 'true';

        function updateUI(user) {
            document.getElementById('author-name').innerText = user;
            const select = document.getElementById('mapel-select');
            select.innerHTML = '<option value="" disabled selected>Pilih Pelajaran...</option>';
            (guruMapel[user] || ["Umum"]).forEach(m => {
                const opt = document.createElement('option'); opt.value = m; opt.innerText = m;
                select.appendChild(opt);
            });
        }

        // Global function for Cloudinary
        window.launchCloudinary = () => {
            cloudinary.openUploadWidget({
                cloudName: CLOUDINARY_CONFIG.cloudName,
                uploadPreset: CLOUDINARY_CONFIG.uploadPreset,
                ...CLOUDINARY_CONFIG.uploadOptions
            }, (error, result) => {
                if (!error && result.event === "success") {
                    const info = result.info;
                    const finalUrl = getOptimizedUrl(info.secure_url);
                    document.getElementById('media-url').value = finalUrl;
                    document.getElementById('media-type').value = info.resource_type;
                    document.getElementById('preview-container').classList.remove('hidden');
                    document.getElementById('placeholder-info').classList.add('hidden');
                }
            });
        };

        window.onload = async () => {
            await signInAnonymously(auth);
            if (isTester) {
                document.getElementById('tester-panel').classList.remove('hidden');
                const ts = document.getElementById('tester-identity-select');
                ts.value = activeUser;
                ts.onchange = (e) => { activeUser = e.target.value; updateUI(activeUser); };
            }
            updateUI(activeUser);
            lucide.createIcons();
        };

        document.getElementById('materi-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.disabled = true; btn.innerText = "MENGIRIM...";

            try {
                const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'materi'), {
                    judul: document.getElementById('judul').value,
                    mapel: document.getElementById('mapel-select').value,
                    deskripsi: document.getElementById('deskripsi').value,
                    konten: document.getElementById('konten').value,
                    media: document.getElementById('media-url').value,
                    mediaType: document.getElementById('media-type').value,
                    author: activeUser,
                    createdAt: new Date().toISOString()
                });
                window.location.href = 'dashboard.html';
            } catch (err) {
                alert("Gagal sinkronisasi data!");
                btn.disabled = false; btn.innerText = "LUNCURKAN MATERI";
            }
        };
    </script>
</body>
</html>


