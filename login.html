<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Academy - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@700;800&family=Orbitron:wght@900&display=swap');
        :root { --bg-deep: #02040a; }
        body { background-color: var(--bg-deep); color: white; font-family: 'Baloo 2', cursive; margin: 0; min-height: 100vh; }
        #star-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at center, #0d1117 0%, #02040a 100%); }
        .zigzag-container { display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .name-card { width: 85%; padding: 20px; border-radius: 25px; position: relative; font-size: 24px; text-align: center; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; border: 4px solid rgba(255,255,255,0.1); }
        .name-card:active { scale: 0.95; }
        .name-card.disabled { opacity: 0.3; grayscale: 100%; pointer-events: none; filter: grayscale(1); }
        .clr-blue { background: linear-gradient(135deg, #1e40af, #3b82f6); --neon-clr: #60a5fa; }
        .clr-purple { background: linear-gradient(135deg, #7e22ce, #a855f7); --neon-clr: #c084fc; }
        .clr-pink { background: linear-gradient(135deg, #be185d, #ec4899); --neon-clr: #f472b6; }
        .clr-lime { background: linear-gradient(135deg, #4d7c0f, #84cc16); --neon-clr: #bef264; }
        .admin-tag { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #ff4757; font-family: 'Orbitron'; font-size: 10px; padding: 2px 10px; border-radius: 10px; box-shadow: 0 0 10px #ff4757; }
        .student-name { text-shadow: 2px 2px 0px rgba(0,0,0,0.3); }
        .taken-label { font-size: 12px; font-weight: bold; color: #ff4d4d; margin-top: 5px; }
    </style>
</head>
<body>
    <canvas id="star-canvas"></canvas>

    <div class="p-5 text-center mt-10">
        <h1 class="text-4xl font-black mb-2 tracking-tighter italic text-transparent bg-clip-text bg-gradient-to-b from-white to-slate-500">STELLAR ACADEMY</h1>
        <p class="text-slate-400 text-sm">Pilih Identitas Astral Anda</p>
    </div>

    <div id="zigzag-list" class="zigzag-container pb-20">
        <!-- List murid akan dimuat di sini -->
        <div class="p-10 text-center text-slate-500 animate-pulse">Menghubungkan ke Pusat Data...</div>
    </div>

    <!-- Modal Konfirmasi -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md hidden p-6">
        <div id="modal-box" class="bg-slate-900 border-4 p-8 rounded-[40px] w-full max-w-sm text-center">
            <h2 class="text-slate-400 uppercase text-xs tracking-[0.2em] mb-2 font-bold">AKTIVASI IDENTITAS</h2>
            <div id="modal-name" class="text-5xl font-black mb-8 italic tracking-tighter">NAME</div>
            <button onclick="confirmEntry()" class="w-full bg-white text-black py-5 rounded-3xl font-black text-xl hover:scale-105 transition-transform active:scale-95 shadow-[0_10px_0_#cbd5e1]">AKTIVASI POS</button>
            <button onclick="closeModal()" class="mt-6 text-slate-500 font-bold uppercase text-xs tracking-widest">BATALKAN</button>
        </div>
    </div>

    <script type="module">
        import { db, doc, setDoc, onSnapshot, collection, signInAnonymously, auth } from './app.js';

        const users = [
            { n: "ADITYA", r: "admin", c: "clr-blue" },
            { n: "AL-FAYAD", r: "murid", c: "clr-purple" },
            { n: "ALBY", r: "murid", c: "clr-pink" },
            { n: "ARESHA", r: "murid", c: "clr-lime" }
        ];

        let selected = null;
        let onlineUsers = {};

        // Login anonim agar bisa baca/tulis Firestore
        signInAnonymously(auth).catch(err => console.error("Auth Error:", err));

        // Pantau status online secara Real-Time
        const appId = 'stellar-class-01'; // ID unik aplikasi Anda
        const statusRef = collection(db, 'artifacts', appId, 'public', 'data', 'user_status');

        onSnapshot(statusRef, (snapshot) => {
            onlineUsers = {};
            snapshot.forEach(doc => {
                onlineUsers[doc.id] = doc.data().isOnline;
            });
            render();
        }, (err) => console.error("Firestore Error:", err));

        window.render = function render() {
            const list = document.getElementById('zigzag-list');
            list.innerHTML = users.map((u, i) => {
                const isTaken = onlineUsers[u.n] === true;
                return `
                    <div class="name-card ${u.c} ${isTaken ? 'disabled' : ''}" 
                         onclick="${isTaken ? '' : `openModal(${i})`}">
                        ${u.r === 'admin' ? '<div class="admin-tag">COMMANDER</div>' : ''}
                        <div class="student-name">${u.n}</div>
                        ${isTaken ? '<div class="taken-label">SUDAH AKTIF</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        window.openModal = function openModal(idx) {
            selected = users[idx];
            const modal = document.getElementById('login-modal');
            const mName = document.getElementById('modal-name');
            const mBox = document.getElementById('modal-box');
            
            mName.innerText = selected.n;
            mName.style.webkitTextStroke = `6px var(--neon-clr)`;
            mBox.style.borderColor = `var(--neon-clr)`;
            mBox.style.boxShadow = `0 0 50px var(--neon-clr)`;
            modal.classList.remove('hidden');
        }

        window.closeModal = function closeModal() {
            document.getElementById('login-modal').classList.add('hidden');
        }

        window.confirmEntry = async function confirmEntry() {
            if (selected) {
                try {
                    // Update Firestore: Kunci nama ini
                    const userDoc = doc(db, 'artifacts', appId, 'public', 'data', 'user_status', selected.n);
                    await setDoc(userDoc, { 
                        isOnline: true, 
                        lastActive: new Date().getTime() 
                    });

                    // Simpan ke Session Lokal
                    localStorage.setItem('userRole', selected.r);
                    localStorage.setItem('userName', selected.n);
                    
                    window.location.href = 'index.html';
                } catch (e) {
                    alert("Gagal sinkronisasi. Coba lagi.");
                }
            }
        }
    </script>
</body>
</html>

