<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Academy - Profil Pengguna</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #050505;
            color: #f8fafc;
        }

        .glass {
            backdrop-filter: blur(16px);
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .neon-text {
            background: linear-gradient(to right, #22d3ee, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
        }

        .checkbox-custom {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-custom:checked {
            background-color: #22d3ee;
            border-color: #22d3ee;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
            background-size: 80%;
            background-position: center;
            background-repeat: no-repeat;
        }
    </style>
</head>
<body class="min-h-screen pb-20">

    <!-- Background Decoration -->
    <div class="fixed inset-0 pointer-events-none -z-10">
        <div class="absolute top-0 right-0 w-[50%] h-[50%] bg-cyan-500/5 blur-[120px]"></div>
        <div class="absolute bottom-0 left-0 w-[50%] h-[50%] bg-purple-500/5 blur-[120px]"></div>
    </div>

    <!-- Header Navigation -->
    <nav class="sticky top-0 z-50 glass border-b border-white/10 px-6 py-4 flex justify-between items-center">
        <a href="dashboard.html" class="flex items-center gap-2 text-slate-400 hover:text-white transition-all group">
            <i data-lucide="arrow-left" class="w-5 h-5 group-hover:-translate-x-1 transition-transform"></i>
            <span class="text-sm font-bold">Kembali</span>
        </a>
        <div class="flex items-center gap-3">
            <button id="btn-switch-role" class="text-[10px] font-black uppercase tracking-tighter px-3 py-1.5 rounded-lg border border-amber-500/30 bg-amber-500/10 text-amber-500 hover:bg-amber-500/20 transition-all">
                Switch Role (Tester)
            </button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-6 mt-12">
        <!-- Profile Header Section -->
        <div class="flex flex-col md:flex-row items-center gap-8 mb-12">
            <div class="relative group">
                <div class="w-32 h-32 rounded-[2.5rem] bg-gradient-to-tr from-cyan-500 to-purple-600 p-1">
                    <div class="w-full h-full rounded-[2.3rem] bg-black overflow-hidden flex items-center justify-center">
                        <img id="avatar-img" src="" alt="Avatar" class="w-full h-full object-cover">
                    </div>
                </div>
            </div>

            <div class="text-center md:text-left">
                <div id="role-label" class="inline-block px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest mb-2">
                    Memuat...
                </div>
                <h1 id="user-fullname" class="text-4xl font-black mb-1 italic tracking-tighter uppercase">...</h1>
                <p id="user-uid-display" class="text-slate-500 text-[10px] font-mono opacity-50">UID: ...</p>
            </div>
        </div>

        <!-- History/Activity Section -->
        <div class="glass rounded-[2.5rem] p-8 border border-white/10">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                <div>
                    <h2 id="history-title" class="text-xl font-bold flex items-center gap-2">
                        <i data-lucide="history" class="w-5 h-5"></i>
                        Riwayat Aktivitas
                    </h2>
                    <p id="history-desc" class="text-xs text-slate-500 mt-1 italic">Menghubungkan ke database...</p>
                </div>
                
                <div id="admin-actions" class="hidden flex items-center gap-2">
                    <button id="btn-bulk-delete" class="text-xs font-bold bg-rose-500/10 text-rose-500 border border-rose-500/20 px-4 py-2 rounded-xl hover:bg-rose-500/20 transition-all flex items-center gap-2">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> Hapus Terpilih
                    </button>
                </div>
            </div>

            <div id="history-list" class="space-y-3">
                <div class="py-20 text-center animate-pulse">
                    <i data-lucide="refresh-cw" class="w-8 h-8 mx-auto mb-2 animate-spin text-slate-700"></i>
                    <p class="text-sm text-slate-600 font-bold uppercase tracking-widest">Sinkronisasi Database...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Edit Materi -->
    <div id="modal-edit" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-6">
        <div class="glass w-full max-w-lg rounded-[2.5rem] p-8 border-cyan-500/20">
            <h3 class="text-2xl font-black mb-6 neon-text uppercase tracking-tighter">Edit Materi</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 block mb-1">Judul Modul</label>
                    <input type="text" id="edit-title" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 outline-none focus:border-cyan-500 text-white font-bold">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 block mb-1">Deskripsi Singkat</label>
                    <textarea id="edit-desc" rows="3" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 outline-none focus:border-cyan-500 text-white text-sm"></textarea>
                </div>
                <div class="flex justify-end gap-3 mt-8">
                    <button onclick="closeModal()" class="px-6 py-3 text-sm font-bold text-slate-400">Batal</button>
                    <button id="btn-save-edit" class="px-8 py-3 bg-cyan-500 text-black font-black rounded-xl hover:bg-cyan-400 shadow-lg shadow-cyan-500/20">SIMPAN PERUBAHAN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Integration -->
    <script type="module">
        import { db, auth, getCurrentUserContext } from './app.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            collection, 
            query, 
            where, 
            onSnapshot, 
            doc, 
            deleteDoc, 
            updateDoc,
            orderBy 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const appId = "sekolah-sdnwidarasari";
        const { name, role, isTester, uid } = getCurrentUserContext();
        
        let activeData = [];

        function init() {
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      // Tidak ada auth → balik ke login
      window.location.href = 'index.html';
      return;
    }

    const { name, role, isTester } = getCurrentUserContext();

    // Header UI
    document.getElementById('user-fullname').innerText = name;
    document.getElementById('user-uid-display').innerText = `ID: ${user.uid}`;
    document.getElementById(
      'avatar-img'
    ).src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`;

    // Pilih view
    if (role === 'admin') {
      setupAdminView();
    } else {
      setupMuridView(user.uid);
    }

    // ✅ TESTER MODE SWITCH (AMAN)
    document.getElementById('btn-switch-role').onclick = () => {
      if (!isTester) {
        alert('Switch role hanya tersedia di tester mode');
        return;
      }

      const newRole = role === 'admin' ? 'murid' : 'admin';
      const newName = newRole === 'admin' ? 'DEV_ADMIN' : 'DEV_MURID';

      localStorage.setItem('userRole', newRole);
      localStorage.setItem('userName', newName);

      window.location.reload();
    };

    lucide.createIcons();
  });
}

// Sesuaikan fungsi setupMuridView untuk menerima parameter UID
function setupMuridView(currentUid) {
  const roleLabel = document.getElementById('role-label');
  roleLabel.innerText = 'Siswa Academy';
  roleLabel.className =
    'inline-block px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest mb-2 bg-cyan-500/10 text-cyan-400 border border-cyan-500/20';

  document.getElementById('history-desc').innerText =
    'Materi yang telah Anda selesaikan atau sedang dipelajari.';

  const q = query(
    collection(
      db,
      'artifacts',
      appId,
      'users',
      currentUid,
      'history_belajar'
    ),
    orderBy('lastAccessed', 'desc')
  );

  onSnapshot(
    q,
    (snapshot) => {
      const history = snapshot.docs.map((d) => ({
        id: d.id,
        ...d.data()
      }));
      renderMuridList(history);
    },
    (err) => {
      console.error('Gagal memuat riwayat:', err);
      document.getElementById('history-list').innerHTML =
        `<div class="py-10 text-center opacity-30 text-sm italic">
          Belum ada riwayat belajar.
        </div>`;
    }
  );
}
        // --- GURU / ADMIN VIEW ---
        function setupAdminView() {
            const roleLabel = document.getElementById('role-label');
            roleLabel.innerText = 'Administrator / Guru';
            roleLabel.className += ' bg-amber-500/10 text-amber-500 border border-amber-500/20';
            
            document.getElementById('history-desc').innerText = 'Daftar materi yang telah Anda publikasikan ke sistem.';
            document.getElementById('admin-actions').classList.remove('hidden');

            // Query Materi yang dibuat oleh user ini
            const q = query(
                collection(db, 'artifacts', appId, 'public', 'data', 'materi'),
                where("author", "==", name)
            );

            onSnapshot(q, (snapshot) => {
                activeData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAdminList(activeData);
            }, (err) => console.error("Firestore Error:", err));
        }

        function renderAdminList(data) {
            const container = document.getElementById('history-list');
            if (data.length === 0) {
                container.innerHTML = `<div class="py-10 text-center opacity-30 text-sm italic">Belum ada materi yang dibuat.</div>`;
                return;
            }

            container.innerHTML = data.map(item => `
                <div class="history-item glass flex items-center justify-between p-4 rounded-2xl transition-all group">
                    <div class="flex items-center gap-4">
                        <input type="checkbox" data-id="${item.id}" class="checkbox-custom">
                        <div>
                            <h4 class="font-bold text-sm text-white">${item.judul}</h4>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">
                                ${item.mapel} • ${new Date(item.createdAt).toLocaleDateString('id-ID')}
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="window.editMateri('${item.id}')" class="p-2 hover:bg-cyan-500/20 rounded-lg text-cyan-400 transition-colors">
                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                        </button>
                        <button onclick="window.deleteMateri('${item.id}')" class="p-2 hover:bg-rose-500/20 rounded-lg text-rose-500 transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderMuridList(data) {
            const container = document.getElementById('history-list');
            if (data.length === 0) {
                container.innerHTML = `<div class="py-10 text-center opacity-30 text-sm italic">Belum ada riwayat belajar.</div>`;
                return;
            }

            container.innerHTML = data.map(item => `
                <div class="history-item glass flex items-center justify-between p-5 rounded-2xl transition-all border-l-4 border-cyan-500/30">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-cyan-500/10 flex items-center justify-center">
                            <i data-lucide="book-open" class="text-cyan-400 w-5 h-5"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-sm text-white">${item.judulMateri}</h4>
                            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Diakses: ${new Date(item.lastAccessed).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-[10px] font-black text-cyan-500 bg-cyan-500/10 px-2 py-1 rounded-md">SELESAI</span>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // --- ACTIONS ---
        window.deleteMateri = async (id) => {
            if (confirm("Hapus materi ini? Tindakan ini tidak dapat dibatalkan.")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'materi', id));
                } catch (e) { alert("Gagal menghapus: " + e.message); }
            }
        };

        window.editMateri = (id) => {
            const item = activeData.find(d => d.id === id);
            if (!item) return;
            
            document.getElementById('edit-title').value = item.judul;
            document.getElementById('edit-desc').value = item.deskripsi;
            document.getElementById('modal-edit').classList.remove('hidden');

            document.getElementById('btn-save-edit').onclick = async () => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'materi', id), {
                        judul: document.getElementById('edit-title').value,
                        deskripsi: document.getElementById('edit-desc').value
                    });
                    closeModal();
                } catch (e) { alert("Gagal update: " + e.message); }
            };
        };

        document.getElementById('btn-bulk-delete').onclick = async () => {
            const checked = document.querySelectorAll('.checkbox-custom:checked');
            if (checked.length === 0) return alert("Pilih item terlebih dahulu");

            if (confirm(`Hapus ${checked.length} materi sekaligus?`)) {
                for (const cb of checked) {
                    const id = cb.getAttribute('data-id');
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'materi', id));
                }
            }
        };

        window.closeModal = () => document.getElementById('modal-edit').classList.add('hidden');

        // Start
        window.onload = init;

    </script>
</body>
</html>




