<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Academy - Buat Materi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Cloudinary SDK (HARUS DULU) -->
<script src="https://upload-widget.cloudinary.com/global/all.js"></script>

<!-- Config Cloudinary (GLOBAL) -->
<script src="cloudinary-config.js"></script>

<!-- Baru script module -->
<script type="module" src="app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #050505; color: white; min-height: 100vh; }
        .glass { backdrop-filter: blur(16px); background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); }
        .neon-text { background: linear-gradient(to right, #22d3ee, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        input, textarea, select { background: rgba(255, 255, 255, 0.05) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; color: white !important; outline: none !important; }
        input:focus, textarea:focus, select:focus { border-color: #22d3ee !important; }
        .tester-badge { background: linear-gradient(45deg, #f59e0b, #ef4444); box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
    </style>
</head>
<body class="p-5 md:p-10">
    <!-- Navigasi -->
        <div class="flex items-center justify-between mb-8">
            <a href="pilihtipe.html" class="flex items-center gap-2 text-slate-400 hover:text-purple-400 transition-colors inline-flex group">
                <i data-lucide="arrow-left" class="w-4 h-4 group-hover:-translate-x-1 transition-transform"></i>
                <span class="text-sm font-bold uppercase tracking-wider">Ganti Tipe Materi</span>
            </a>
        <div class="text-right">
            <h1 class="text-2xl font-black tracking-tighter uppercase neon-text">Mission Control</h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Stellar Sync Engine</p>
        </div>
    </div>

    <!-- Panel Tester -->
    <div id="tester-panel" class="max-w-4xl mx-auto mb-6 hidden">
        <div class="glass border-orange-500/30 rounded-2xl p-4 flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="tester-badge text-[10px] font-black px-2 py-1 rounded-md text-white uppercase">Tester Mode</div>
                <p class="text-sm text-slate-300 italic">Ganti identitas guru untuk tes filter:</p>
            </div>
            <select id="tester-identity-select" class="p-2 rounded-lg text-sm glass cursor-pointer border-orange-500/50 min-w-[200px]">
                <option value="">Pilih Guru...</option>
                <option value="IBU YAYAH">Ibu Yayah (Wali Kelas)</option>
                <option value="BPK JAJANG">Bapak Jajang (PJOK)</option>
                <option value="IBU ILAH">Ibu Ilah (B. Inggris)</option>
                <option value="IBU LINA">Ibu Lina (PAI)</option>
                <option value="DEV_ADMIN">Developer Admin</option>
            </select>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <div class="glass rounded-3xl p-8 border border-white/10 relative overflow-hidden">
            <form id="materi-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-300">Judul Modul</label>
                        <input type="text" id="judul" placeholder="Judul Materi..." class="w-full p-4 rounded-2xl" required>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-300">Mata Pelajaran</label>
                        <select id="mapel-select" class="w-full p-4 rounded-2xl appearance-none cursor-pointer" required>
                            <!-- Diisi via JS -->
                        </select>
                    </div>
                </div>

                <!-- Media Upload Area -->
                <div class="space-y-2">
                    <label class="text-sm font-semibold text-slate-300">Media Pendukung</label>
                    <div id="btn-upload" class="border-2 border-dashed border-white/10 rounded-2xl p-8 text-center hover:border-cyan-500/50 transition-all cursor-pointer group bg-white/5">
                       <div id="preview-info" class="hidden flex flex-col items-center gap-2">
    <div class="inline-flex items-center gap-2 bg-cyan-500/20 text-cyan-400 px-4 py-2 rounded-xl border border-cyan-500/30 text-sm">
        <i data-lucide="file-check" class="w-4 h-4"></i>
        <span id="file-label">Media Terlampir</span>
    </div>
    <button type="button" id="btn-remove-media" class="text-[10px] font-black uppercase tracking-widest text-red-400 hover:text-red-300 transition-colors flex items-center gap-1">
        <i data-lucide="trash-2" class="w-3 h-3"></i> Hapus Media
    </button>
</div>
                        <div id="upload-prompt">
                            <i data-lucide="upload-cloud" class="w-10 h-10 mx-auto text-slate-600 group-hover:text-cyan-400 mb-2 transition-colors"></i>
                            <p class="text-sm text-slate-400">Klik untuk unggah (Cloudinary)</p>
                        </div>
                    </div>
                    <input type="hidden" id="media-url">
                    <input type="hidden" id="media-type">
                </div>

                <div class="space-y-2">
                    <label class="text-sm font-semibold text-slate-300">Deskripsi Ringkas</label>
                    <input type="text" id="deskripsi" placeholder="Snippet materi..." class="w-full p-4 rounded-2xl">
                </div>

                <div class="space-y-2">
                    <label class="text-sm font-semibold text-slate-300">Isi Materi / Konten</label>
                    <textarea id="konten" rows="6" placeholder="Tulis materi di sini..." class="w-full p-4 rounded-2xl" required></textarea>
                </div>

                <div class="flex flex-col md:flex-row items-center justify-between gap-4 pt-6 border-t border-white/5">
                    <div class="flex items-center gap-3 text-sm text-slate-500">
                        <i data-lucide="user" class="w-4 h-4"></i>
                        <span>Oleh: <b id="display-author" class="text-cyan-400 uppercase">...</b></span>
                    </div>
                    <button type="submit" id="btn-submit" class="w-full md:w-auto px-10 py-4 bg-white text-black font-bold rounded-2xl hover:bg-cyan-400 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="send" class="w-5 h-5"></i>
                        PUBLIKASIKAN
                    </button>
                </div>
            </form>
<div class="mt-12 pt-10 border-t border-white/10">
    <h2 class="text-xs font-black uppercase tracking-[0.3em] text-slate-500 mb-8 flex items-center gap-2">
        <i data-lucide="eye" class="w-4 h-4"></i> Live Preview
    </h2>
    
    <article class="space-y-8 max-w-2xl mx-auto opacity-60 hover:opacity-100 transition-opacity">
        <header class="space-y-4">
            <span id="preview-mapel-tag" class="text-[10px] font-black uppercase text-cyan-400 bg-cyan-500/10 px-3 py-1.5 rounded-lg border border-cyan-500/20 tracking-widest">MAPEL</span>
            <h2 id="preview-display-title" class="text-3xl md:text-5xl font-black uppercase italic tracking-tighter leading-[0.9] text-white">JUDUL PRATINJAU</h2>
        </header>

        <div id="preview-display-media" class="w-full rounded-3xl overflow-hidden bg-white/5 border border-white/10 hidden">
            </div>

        <div class="glass p-8 rounded-[2rem] border-white/5 relative overflow-hidden">
            <div id="preview-display-content" class="text-slate-200 whitespace-pre-wrap text-sm md:text-base leading-relaxed opacity-90">
                Konten pratinjau akan muncul di sini...
            </div>
        </div>
    </article>
</div>

        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 glass px-8 py-4 rounded-2xl text-cyan-400 font-bold hidden items-center gap-3 shadow-2xl">
        <i data-lucide="check-circle"></i> Berhasil diunggah!
    </div>
<script type="module">
import { db } from './app.js';
import { collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getCurrentUserContext } from './app.js';

const appId = "sekolah-sdnwidarasari";

/* =========================
   MAPEL RULES
========================= */
const MAPEL_RULES = {
  "IBU YAYAH": ["Pendidikan Pancasila", "Bahasa Indonesia", "Matematika", "Seni Budaya", "Bahasa Sunda"],
  "BPK JAJANG": ["PJOK"],
  "IBU ILAH": ["Bahasa Inggris"],
  "IBU LINA": ["Agama Islam"],
  "DEV_ADMIN": [
    "Pendidikan Pancasila",
    "Bahasa Indonesia",
    "Matematika",
    "PJOK",
    "Bahasa Inggris",
    "Agama Islam",
    "Seni Budaya",
    "Bahasa Sunda"
  ]
};

/* =========================
   USER CONTEXT
========================= */
let { name: currentAuthor, isTester } = getCurrentUserContext();
currentAuthor = (currentAuthor || "").toUpperCase();

const savedTester = sessionStorage.getItem("active_tester_name");
if (isTester && savedTester) currentAuthor = savedTester;

/* =========================
   UI HELPERS
========================= */
function updateMapel(name) {
  const select = document.getElementById('mapel-select');
  select.innerHTML = `<option value="" disabled selected>Pilih Mapel...</option>`;

  const list = MAPEL_RULES[name] || ["Materi Umum"];
  list.forEach(m => {
    const opt = document.createElement('option');
    opt.value = m;
    opt.textContent = m;
    select.appendChild(opt);
  });
}

function updateAuthorUI() {
  document.getElementById('display-author').innerText = currentAuthor;
  updateMapel(currentAuthor);
}

/* =========================
   LIVE PREVIEW (GLOBAL)
========================= */
window.updatePreview = function () {
  const judul = document.getElementById('judul').value;
  const mapel = document.getElementById('mapel-select').value;
  const konten = document.getElementById('konten').value;

  document.getElementById('preview-display-title').innerText =
    judul || "JUDUL PRATINJAU";

  document.getElementById('preview-mapel-tag').innerText =
    mapel || "MAPEL";

  document.getElementById('preview-display-content').innerText =
    konten || "Konten pratinjau akan muncul di sini...";

  const mediaUrl = document.getElementById('media-url').value;
  const mediaType = document.getElementById('media-type').value;
  const box = document.getElementById('preview-display-media');

  if (!mediaUrl) {
    box.classList.add('hidden');
    box.innerHTML = "";
    return;
  }

  box.classList.remove('hidden');

  if (mediaType === "video") {
    box.innerHTML = `<video src="${mediaUrl}" controls class="w-full aspect-video bg-black"></video>`;
  } else {
    box.innerHTML = `<img src="${mediaUrl}" class="w-full h-auto object-cover">`;
  }
};

/* =========================
   INIT
========================= */
window.addEventListener('DOMContentLoaded', () => {
  // tester mode
  if (isTester) {
    document.getElementById('tester-panel').classList.remove('hidden');
    const tSel = document.getElementById('tester-identity-select');
    tSel.value = currentAuthor;

    tSel.onchange = e => {
      currentAuthor = e.target.value.toUpperCase();
      sessionStorage.setItem("active_tester_name", currentAuthor);
      updateAuthorUI();
      updatePreview();
    };
  }

  updateAuthorUI();
  lucide.createIcons();

  // live preview inputs
  ['judul', 'mapel-select', 'konten'].forEach(id => {
    document.getElementById(id).addEventListener('input', updatePreview);
  });
});

/* =========================
   HAPUS MEDIA
========================= */
const removeBtn = document.getElementById('btn-remove-media');
if (removeBtn) {
  removeBtn.addEventListener('click', e => {
    e.preventDefault();
    e.stopPropagation();

    document.getElementById('media-url').value = "";
    document.getElementById('media-type').value = "";

    document.getElementById('preview-info').classList.add('hidden');
    document.getElementById('upload-prompt').classList.remove('hidden');

    updatePreview();
  });
}

/* =========================
   CLOUDINARY UPLOAD
========================= */
const uploadBtn = document.getElementById('btn-upload');

if (uploadBtn) {
  uploadBtn.addEventListener('click', () => {
    if (!window.cloudinary || !window.CLOUDINARY_CONFIG) {
      alert("Cloudinary belum siap");
      return;
    }

    window.cloudinary.openUploadWidget(
      {
        cloudName: window.CLOUDINARY_CONFIG.cloudName,
        uploadPreset: window.CLOUDINARY_CONFIG.uploadPreset,
        sources: window.CLOUDINARY_CONFIG.uploadOptions.sources,
        multiple: false,
        styles: window.CLOUDINARY_CONFIG.uploadOptions.styles
      },
      (err, res) => {
        if (!err && res.event === "success") {
          document.getElementById('media-url').value = res.info.secure_url;
          document.getElementById('media-type').value = res.info.resource_type;

          document.getElementById('preview-info').classList.remove('hidden');
          document.getElementById('upload-prompt').classList.add('hidden');

          updatePreview();
        }
      }
    );
  });
}

/* =========================
   SUBMIT FORM
========================= */
document.getElementById('materi-form').onsubmit = async (e) => {
  e.preventDefault();

  const btn = document.getElementById('btn-submit');
  btn.disabled = true;
  btn.innerText = "SINKRONISASI...";

  try {
  const { uid } = getCurrentUserContext();
  if (!uid) throw new Error("UID tidak ditemukan");

  const timestamp = Date.now();

  const materiData = {
    tipe: "belajar",
    judul: document.getElementById('judul').value,
    mapel: document.getElementById('mapel-select').value,
    deskripsi: document.getElementById('deskripsi').value,
    konten: document.getElementById('konten').value,
    media: document.getElementById('media-url').value || "",
    mediaType: document.getElementById('media-type').value || "none",
    author: currentAuthor,
    createdAt: timestamp
  };

  await addDoc(
    collection(db, 'artifacts', appId, 'public', 'data', 'materi'),
    materiData
  );

  await addDoc(
    collection(db, 'artifacts', appId, 'users', uid, 'history_belajar'),
    {
      judulMateri: materiData.judul,
      tipe: "belajar",
      mapel: materiData.mapel,
      lastAccessed: timestamp
    }
  );

  // ✅ NOTIFIKASI SUKSES
  document.getElementById('toast').classList.remove('hidden');

  // ⏳ DELAY REDIRECT
  setTimeout(() => {
    location.href = "profile.html";
  }, 1800);

} catch (err) {
  console.error(err);
  alert("Gagal menyimpan materi");
  btn.disabled = false;
  btn.innerText = "PUBLIKASIKAN";
}
</script>
</body>
</html>

